library(sf)
# Define Kelowna bounding box in latitude/longitude
kelowna_bbox <- st_bbox(c(
xmin = -119.682898,  # West
ymin = 49.774166,    # South
xmax = -119.319783,  # East
ymax = 49.974244     # North
), crs = 4326)
# Convert to BC Albers (EPSG:3005)
kelowna_bbox_3005 <- st_transform(st_as_sfc(kelowna_bbox), 3005)
st_bbox(kelowna_bbox_3005)
# Extract numeric coordinates for query
coords <- st_bbox(kelowna_bbox_3005)
# Build WFS request with EPSG:3005 (the correct CRS)
wfs_url <- paste0(
"https://openmaps.gov.bc.ca/geo/pub/WHSE_BASEMAPPING.DRA_DGTL_ROAD_ATLAS_MPAR_SP/ows?",
"service=WFS&version=2.0.0&request=GetFeature&",
"typename=pub:WHSE_BASEMAPPING.DRA_DGTL_ROAD_ATLAS_MPAR_SP&",
"srsName=EPSG:3005&",
"bbox=", coords["xmin"], ",", coords["ymin"], ",", coords["xmax"], ",", coords["ymax"], ",EPSG:3005"
)
# Read the layer
roads_kelowna <- st_read(wfs_url)
st_crs(roads_kelowna) <- 3005
# Save locally
dir.create("data_kelowna", showWarnings = FALSE)
st_write(roads_kelowna, "data_kelowna/DRA_Kelowna_Subset.gpkg", delete_dsn = TRUE)
library(sf)
library(tidyverse)
# Read your saved shapefile
roads <- st_read("data_kelowna/DRA_Kelowna_Subset.gpkg")
# Quick look
st_geometry_type(roads)
names(roads)
nrow(roads)
# Quick plot
roads_ll <- st_transform(roads, 4326)  # Convert to lat/lon (degrees)
plot(st_geometry(roads_ll), col = "gray", main = "Kelowna Road Network (Geographic View)")
library(dplyr)
library(knitr)
# Drop geometry for attribute inspection
road_attrs <- st_drop_geometry(roads)
# Create a summary table of field names, data types, and examples
attr_summary <- tibble(
Field_Name = names(road_attrs),
Data_Type = sapply(road_attrs, class),
Example_Value = sapply(road_attrs, function(x) as.character(x[which(!is.na(x))[1]]))
)
# Display neatly
kable(attr_summary, caption = "Attributes in the Kelowna DRA Road Dataset (Sample Values)")
library(sf)
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
library(tibble)
library(purrr)
# Paths
gpkg_path <- "data_kelowna/DRA_Kelowna_Subset.gpkg"
out_dir   <- "data_kelowna"
# Load roads
roads_raw <- st_read(gpkg_path, quiet = TRUE)
# Ensure projected CRS in meters (BC Albers)
if (st_crs(roads_raw)$epsg != 3005) {
roads_raw <- st_transform(roads_raw, 3005)
}
# Normalize: cast to LINESTRING (explode MULTILINESTRING)
roads <- roads_raw |>
st_cast("LINESTRING", warn = FALSE) |>
st_make_valid()
# Add a stable segment id
roads <- roads |> mutate(seg_id = row_number())
# Quick look
table(st_geometry_type(roads))
print(st_crs(roads))
nrow(roads)
roads <- roads %>%
mutate(seg_id = row_number(),
length_m = as.numeric(st_length(geometry)))
roads <- st_read("data_kelowna/DRA_Kelowna_Subset.gpkg", quiet = TRUE)
roads <- roads |>
st_cast("LINESTRING") |>
st_make_valid()
roads <- roads %>%
mutate(seg_id = row_number(),
length_m = as.numeric(st_length(geometry)))
roads <- st_read("data_kelowna/DRA_Kelowna_Subset.gpkg", quiet = TRUE)
roads <- roads |>
st_cast("LINESTRING") |>
st_make_valid()
roads <- roads %>%
mutate(seg_id = row_number(),
length_m = as.numeric(st_length(geometry)))
roads <- st_read("data_kelowna/DRA_Kelowna_Subset.gpkg", quiet = TRUE)
roads <- roads |>
st_cast("LINESTRING") |>
st_make_valid()
roads <- roads |>
mutate(
seg_id = row_number(),
length_m = as.numeric(st_length(geometry))   # geometry exists here âœ…
)
roads <- roads %>%
mutate(length_m = as.numeric(st_length(geometry)))
roads$length_m <- as.numeric(st_length(roads))
roads$length_m <- as.numeric(st_length(roads))
edges <- roads %>%
mutate(
road_name = coalesce(ROAD_NAME_FULL, ROAD_NAME_ALIAS1, ROAD_NAME_ALIAS2,
ROAD_NAME_ALIAS3, ROAD_NAME_ALIAS4)
) %>%
st_drop_geometry() %>%
select(
edge_id = seg_id,
road_name,
road_class   = ROAD_CLASS,
road_surface = ROAD_SURFACE,
lanes        = NUMBER_OF_LANES,
highway_rt   = HIGHWAY_ROUTE_NUMBER,
length_m
)
roads <- roads %>%
mutate(
# fallback if FEATURE_LENGTH_M exists but is NA
length_calc = as.numeric(st_length(geometry)),
length_m = if_else(!is.na(FEATURE_LENGTH_M), FEATURE_LENGTH_M, length_calc)
)
# Create two length columns: official vs computed
roads$length_feature_m <- roads$FEATURE_LENGTH_M                   # official DRA length
roads$length_calc_m     <- as.numeric(st_length(st_geometry(roads))) # computed length
edges <- roads %>%
mutate(
road_name = coalesce(
ROAD_NAME_FULL, ROAD_NAME_ALIAS1, ROAD_NAME_ALIAS2,
ROAD_NAME_ALIAS3, ROAD_NAME_ALIAS4
)
) %>%
st_drop_geometry() %>%
select(
edge_id = DIGITAL_ROAD_ATLAS_LINE_ID,
road_name,
road_class   = ROAD_CLASS,
road_surface = ROAD_SURFACE,
lanes        = NUMBER_OF_LANES,
highway_rt   = HIGHWAY_ROUTE_NUMBER,
length_feature_m,
length_calc_m
)
readr::write_csv(edges, file.path(out_dir, "edges.csv"))
head(edges)
# Extract endpoints
start_pts <- st_startpoint(st_geometry(roads))
# Extract endpoints
coords <- st_coordinates(roads)
# Create table of first and last points per segment
endpoints <- coords %>%
as.data.frame() %>%
group_by(L1) %>%   # L1 = feature index in sf object
summarize(
start_x = first(X),
start_y = first(Y),
end_x   = last(X),
end_y   = last(Y)
) %>%
ungroup() %>%
mutate(edge_id = roads$seg_id)
# Extract endpoints
coords <- st_coordinates(roads)
# Create table of first and last points per segment
endpoints <- coords %>%
as.data.frame() %>%
group_by(L1) %>%   # L1 = feature index in sf object
summarize(
start_x = first(X),
start_y = first(Y),
end_x   = last(X),
end_y   = last(Y)
) %>%
ungroup() %>%
mutate(edge_id = roads$seg_id)
endpoints_long <- endpoints %>%
pivot_longer(
cols = c(start_x, start_y, end_x, end_y),
names_to = c("pos", ".value"),
names_pattern = "(start|end)_(x|y)"
) %>%
rename(x = x, y = y)
# Extract endpoints
coords <- st_coordinates(roads)
# Create table of first and last points per segment
endpoints <- coords %>%
as.data.frame() %>%
group_by(L1) %>%   # L1 = feature index in sf object
summarize(
start_x = first(X),
start_y = first(Y),
end_x   = last(X),
end_y   = last(Y)
) %>%
ungroup() %>%
mutate(edge_id = roads$seg_id)
endpoints_long <- endpoints %>%
pivot_longer(
cols = c(start_x, start_y, end_x, end_y),
names_to = c("pos", ".value"),
names_pattern = "(start|end)_(x|y)"
) %>%
rename(x = x, y = y)
tol <- 0.5  # 50cm tolerance
endpoints_long <- endpoints_long %>%
mutate(
x_r = round(x / tol) * tol,
y_r = round(y / tol) * tol,
node_key = paste0(x_r,"_",y_r)
)
nodes <- endpoints_long %>%
distinct(node_key, x = x_r, y = y_r) %>%
arrange(node_key) %>%
mutate(node_id = row_number())
# Extract endpoints
coords <- st_coordinates(roads)
# Create table of first and last points per segment
endpoints <- coords %>%
as.data.frame() %>%
group_by(L1) %>%   # L1 = feature index in sf object
summarize(
start_x = first(X),
start_y = first(Y),
end_x   = last(X),
end_y   = last(Y)
) %>%
ungroup() %>%
mutate(edge_id = roads$seg_id)
endpoints_long <- endpoints %>%
pivot_longer(
cols = c(start_x, start_y, end_x, end_y),
names_to = c("pos", ".value"),
names_pattern = "(start|end)_(x|y)"
) %>%
rename(x = x, y = y)
tol <- 0.5  # 50cm tolerance
endpoints_long <- endpoints_long %>%
mutate(
x_r = round(x / tol) * tol,
y_r = round(y / tol) * tol,
node_key = paste0(x_r,"_",y_r)
)
nodes <- endpoints_long %>%
distinct(node_key, x = x_r, y = y_r) %>%
arrange(node_key) %>%
mutate(node_id = row_number())
edge_nodes <- endpoints_long %>%
left_join(nodes, by = c("node_key","x_r" = "x","y_r" = "y")) %>%
select(edge_id, pos, node_id) %>%
pivot_wider(names_from = pos, values_from = node_id) %>%
rename(from = start, to = end)
# Extract endpoints
coords <- st_coordinates(roads)
coords_df <- cbind(coords, edge_id = roads$DIGITAL_ROAD_ATLAS_LINE_ID[coords[,"L1"]])
# Create table of first and last points per segment
endpoints <- coords_df %>%
as_tibble() %>%
group_by(edge_id) %>%
summarize(
start_x = first(X),
start_y = first(Y),
end_x   = last(X),
end_y   = last(Y),
.groups = "drop"
)
# Convert to long format (start/end points)
endpoints_long <- endpoints %>%
pivot_longer(
cols = c(start_x, start_y, end_x, end_y),
names_to = c("pos", ".value"),
names_pattern = "(start|end)_(x|y)"
)
tol <- 0.5
endpoints_long <- endpoints_long %>%
mutate(
x_r = round(x / tol) * tol,
y_r = round(y / tol) * tol,
node_key = paste0(x_r,"_",y_r)
)
nodes <- endpoints_long %>%
distinct(node_key, x = x_r, y = y_r) %>%
arrange(node_key) %>%
mutate(node_id = row_number())
edge_nodes <- endpoints_long %>%
left_join(nodes, by = c("node_key","x_r" = "x","y_r" = "y")) %>%
select(edge_id, pos, node_id) %>%
pivot_wider(names_from = pos, values_from = node_id) %>%
rename(from = start, to = end)
edges_final <- edges %>%
left_join(edge_nodes, by = "edge_id") %>%
filter(!is.na(from), !is.na(to))
write_csv(nodes %>% select(node_id, x, y), file.path(out_dir, "nodes.csv"))
write_csv(edges_final, file.path(out_dir, "edges_with_nodes.csv"))
# Extract endpoints
coords <- st_coordinates(roads)
coords_df <- cbind(coords, edge_id = roads$DIGITAL_ROAD_ATLAS_LINE_ID[coords[,"L1"]])
# Create table of first and last points per segment
endpoints <- coords_df %>%
as_tibble() %>%
group_by(edge_id) %>%
summarize(
start_x = first(X),
start_y = first(Y),
end_x   = last(X),
end_y   = last(Y),
.groups = "drop"
)
# Convert to long format (start/end points)
endpoints_long <- endpoints %>%
pivot_longer(
cols = c(start_x, start_y, end_x, end_y),
names_to = c("pos", ".value"),
names_pattern = "(start|end)_(x|y)"
)
tol <- 0.5
endpoints_long <- endpoints_long %>%
mutate(
x_r = round(x / tol) * tol,
y_r = round(y / tol) * tol,
node_key = paste0(x_r,"_",y_r)
)
nodes <- endpoints_long %>%
distinct(node_key, x = x_r, y = y_r) %>%
arrange(node_key) %>%
mutate(node_id = row_number())
edge_nodes <- endpoints_long %>%
left_join(nodes, by = c("node_key","x_r" = "x","y_r" = "y")) %>%
select(edge_id, pos, node_id) %>%
pivot_wider(names_from = pos, values_from = node_id) %>%
rename(from = start, to = end)
edges_final <- edges %>%
left_join(edge_nodes, by = "edge_id") %>%
filter(!is.na(from), !is.na(to))
write_csv(nodes %>% select(node_id, x, y), file.path(out_dir, "nodes.csv"))
write_csv(edges_final, file.path(out_dir, "edges_with_nodes.csv"))
head(nodes)
head(edges_final)
nrow(nodes)
nrow(edges_final)
library(sf)
library(dplyr)
library(readr)
nodes <- read_csv("data_kelowna/nodes.csv")
edges <- read_csv("data_kelowna/edges_with_nodes.csv")
roads <- st_read("data_kelowna/DRA_Kelowna_Subset.gpkg", quiet = TRUE)
nodes_sf <- st_as_sf(
nodes,
coords = c("x", "y"),
crs = st_crs(roads)
)
plot(st_geometry(roads), col = "grey80", lwd = 0.6, main = "Kelowna Road Network")
plot(st_geometry(nodes_sf), col = "red", pch = 20, cex = 0.3, add = TRUE)
library(igraph)
g <- graph_from_data_frame(
d = edges %>% select(from, to),
vertices = nodes %>% mutate(node = node_id),
directed = FALSE
)
# Basic igraph plot
plot(
g,
vertex.size = 1,
vertex.label = NA,
edge.arrow.size = 0,
main = "Kelowna Road Graph (network view)"
)
