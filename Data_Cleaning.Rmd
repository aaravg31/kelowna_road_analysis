---
title: "Data_Cleaning"
author: "Aarav Gosalia 42576439"
date: "2025-11-04"
output: html_document
---

## Setup
```{r setup, message=FALSE, warning=FALSE}
library(sf)
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
library(tibble)
library(purrr)

# Paths
gpkg_path <- "data_kelowna/DRA_Kelowna_Subset.gpkg"
out_dir   <- "data_kelowna"

# Load roads
roads_raw <- st_read(gpkg_path, quiet = TRUE)

# Ensure projected CRS in meters (BC Albers)
if (st_crs(roads_raw)$epsg != 3005) {
  roads_raw <- st_transform(roads_raw, 3005)
}

# Normalize: cast to LINESTRING (explode MULTILINESTRING)
roads <- roads_raw |> 
  st_cast("LINESTRING", warn = FALSE) |>
  st_make_valid()

# Add a stable segment id
roads <- roads |> mutate(seg_id = row_number())

# Quick look
table(st_geometry_type(roads))
print(st_crs(roads))
nrow(roads)
```

```{r}
# Create two length columns: official vs computed
roads$length_feature_m <- roads$FEATURE_LENGTH_M                   # official DRA length
roads$length_calc_m     <- as.numeric(st_length(st_geometry(roads))) # computed length

edges <- roads %>%
  mutate(
    road_name = coalesce(
      ROAD_NAME_FULL, ROAD_NAME_ALIAS1, ROAD_NAME_ALIAS2,
      ROAD_NAME_ALIAS3, ROAD_NAME_ALIAS4
    )
  ) %>%
  st_drop_geometry() %>%
  select(
    edge_id = DIGITAL_ROAD_ATLAS_LINE_ID,
    road_name,
    road_class   = ROAD_CLASS,
    road_surface = ROAD_SURFACE,
    lanes        = NUMBER_OF_LANES,
    highway_rt   = HIGHWAY_ROUTE_NUMBER,
    length_feature_m,
    length_calc_m
  )

readr::write_csv(edges, file.path(out_dir, "edges.csv"))
head(edges)
```

```{r}
# Extract endpoints
coords <- st_coordinates(roads)

coords_df <- cbind(coords, edge_id = roads$DIGITAL_ROAD_ATLAS_LINE_ID[coords[,"L1"]])

# Create table of first and last points per segment
endpoints <- coords_df %>%
  as_tibble() %>%
  group_by(edge_id) %>%
  summarize(
    start_x = first(X),
    start_y = first(Y),
    end_x   = last(X),
    end_y   = last(Y),
    .groups = "drop"
  )

# Convert to long format (start/end points)
endpoints_long <- endpoints %>%
  pivot_longer(
    cols = c(start_x, start_y, end_x, end_y),
    names_to = c("pos", ".value"),
    names_pattern = "(start|end)_(x|y)"
  )

tol <- 0.5
endpoints_long <- endpoints_long %>%
  mutate(
    x_r = round(x / tol) * tol,
    y_r = round(y / tol) * tol,
    node_key = paste0(x_r,"_",y_r)
  )

nodes <- endpoints_long %>%
  distinct(node_key, x = x_r, y = y_r) %>%
  arrange(node_key) %>%
  mutate(node_id = row_number())

edge_nodes <- endpoints_long %>%
  left_join(nodes, by = c("node_key","x_r" = "x","y_r" = "y")) %>%
  select(edge_id, pos, node_id) %>%
  pivot_wider(names_from = pos, values_from = node_id) %>%
  rename(from = start, to = end)

edges_final <- edges %>%
  left_join(edge_nodes, by = "edge_id") %>%
  filter(!is.na(from), !is.na(to))

write_csv(nodes %>% select(node_id, x, y), file.path(out_dir, "nodes.csv"))
write_csv(edges_final, file.path(out_dir, "edges_with_nodes.csv"))

head(nodes)
head(edges_final)
nrow(nodes)
nrow(edges_final)
```

```{r}
library(sf)
library(dplyr)
library(readr)

nodes <- read_csv("data_kelowna/nodes.csv")
edges <- read_csv("data_kelowna/edges_with_nodes.csv")
roads <- st_read("data_kelowna/DRA_Kelowna_Subset.gpkg", quiet = TRUE)

nodes_sf <- st_as_sf(
  nodes,
  coords = c("x", "y"),
  crs = st_crs(roads)
)

plot(st_geometry(roads), col = "grey80", lwd = 0.6, main = "Kelowna Road Network")
plot(st_geometry(nodes_sf), col = "red", pch = 20, cex = 0.3, add = TRUE)

library(igraph)

g <- graph_from_data_frame(
  d = edges %>% select(from, to),
  vertices = nodes %>% mutate(node = node_id),
  directed = FALSE
)

# Basic igraph plot
plot(
  g,
  vertex.size = 1,
  vertex.label = NA,
  edge.arrow.size = 0,
  main = "Kelowna Road Graph (network view)"
)
```

